# -*- coding: utf-8 -*-
"""ì¹´ë“œ ê±°ë˜ì´ë ¥ ë¶„ì„ì„ í†µí•œ ê³ ê° íŠ¹ì„± íŒŒì•….ipynb

Automatically generated by Colaboratory.

Original file is located at
    https://colab.research.google.com/drive/1-xda1Gmy728zOfxDjhIu5USfSbKvibsn

# ì¹´ë“œ ê±°ë˜ì´ë ¥ ë¶„ì„ì„ í†µí•œ ê³ ê° íŠ¹ì„± íŒŒì•…

> ëª©ì°¨

- í”„ë¡œì íŠ¸ Summary
- ë¬¸ì œìƒí™©
- PROCESS01
- PROCESS02
- PROCESS03

## í”„ë¡œì íŠ¸ Summary
-----
> í”„ë¡œì íŠ¸ëª…

â–¶ ì¹´ë“œê±°ë˜ì´ë ¥ ë¶„ì„ì„ í†µí•œ ê³ ê° íŠ¹ì„± íŒŒì•…

> í”„ë¡œì íŠ¸ ìœ í˜•

â–¶ ë°ì´í„° EDA ë° ì¸ì‚¬ì´íŠ¸ ì¶”ì¶œ

> í•™ìŠµëª©í‘œ

â–¶ ë°ì´í„°ë¥¼ ì „ì²˜ë¦¬í•  ìˆ˜ ìˆëŠ” ì—­ëŸ‰ ìŠµë“
â–¶ ê°€ì„¤ ìˆ˜ë¦½, ë°ì´í„° í•¸ë“¤ë§ì„ í†µí•´ ì¸ì‚¬ì´íŠ¸ë¥´ë¥´ ì¶”ì¶œí•  ìˆ˜ ìˆëŠ” ì—­ëŸ‰ ìŠµë“

## ë¬¸ì œìƒí™© ì„¤ëª…
------
> ì‹œë‚˜ë¦¬ì˜¤

```
Aì‚¬ëŠ” ì‹ ê·œ ë¸Œëœë“œì˜ ì í¬ë¥¼ ì…ì ì‹œí‚¤ë ¤ëŠ” ê³„íšì„ ê°–ê³ ìˆìœ¼ë©°,
ì‹ ê·œ ë¸Œëœë“œì´ê¸° ë•Œë¬¸ì— ê³¼ê±° ìƒê¶Œì— ëŒ€í•œ ì •ë³´ê°€ ì—†ì–´, ì–´ëŠ ì§€ì—­ì— ì…ì ì„ ì‹œì¼œì•¼ í• ì§€ ê³ ë¯¼ì´ ë§ë‹¤.
ê³ ë¯¼ ëì— ì§€ì—­Bë¥¼ ìµœì¢… í›„ë³´ë¡œ ì •í–ˆì§€ë§Œ ìì‹ ë“¤ì˜ ë¸Œëœë“œì™€ í•´ë‹¹ ì§€ì—­ì— ê±°ì£¼í•˜ëŠ” ê³ ê°ì˜ ì†Œë¹„ì„±í–¥ê³¼ ë¹„ìŠ·í•œì§€ê°€ ì•„ì§ ì˜ë¬¸!
ë”°ë¼ì„œ ì‹ ìš©ì¹´ë“œì‚¬ì—ì„œ ë°ì´í„°ë¥¼ ë°›ì•„ì„œ ê³ ê°ì˜ ì†Œë¹„ì„±í–¥ì„ ë¶„ì„í•´ë³´ë ¤ê³  í•œë‹¤.
```

> ë¬¸ì œì •ì˜

â–¶ ì‹ ê·œ ë¸Œëœë“œ ì…ì  ìƒê¶Œ ë¶ˆë¶„ëª…

> ê¸°ëŒ€íš¨ê³¼

â–¶ ì‹ ê·œ ìƒê¶Œ ì…ì  ì—¬ë¶€ ê²°ì • ë° ìƒê¶Œì˜ ê³ ê° ì´í•´

> í•´ê²°ë°©ì•ˆ

â–¶ ì¹´ë“œì‚¬ ë°ì´í„°ë¥¼ í™œìš©í•´ ì§€ì—­ ê±°ì£¼ ê³ ê° ì†Œë¹„ì„±í–¥ì„ íŒŒì•… í›„ ë¸Œëœë“œê³¼ ë§¤ì¹­ì„ í†µí•´ ì…ì  ê²°ì •

> ì„±ê³¼ì¸¡ì •

â–¶ ì‹ ê·œ ì§‘ì… ê²°ì • ì—¬ë¶€

> í˜„ì—…ì ìš©

â–¶ ì¸ì‚¬ì´íŠ¸ Report ì‘ì„± ë° ë³´ê³ 

> ë°ì´í„° ì‚´í´ë³´ê¸°
- ìƒì  IDë³„ ì¹´ë“œ Spending Data
- ë°ì´í„° ëª…ì„¸

|Store_id|date|time|card_id|amount|installments|dats_of_week|holyday|
|:--:|:--:|:--:|:--:|:--:|:--:|:--:|:--:|
|ìƒì ID|ë‚ ì§œ|ì‹œê°„|ì¹´ë“œID|ë§¤ì¶œì•¡(ìŒìˆ˜ëŠ” ê±°ë˜ ì·¨ì†Œ)|í• ë¶€ê°œì›”, ì¼ì‹œë¶ˆì€ ë¹ˆë¬¸ìì—´|ìš”ì¼(ì›”ìš”ì¼0,ì¼ìš”ì¼6)|ê³µíœ´ì¼ì—¬ë¶€|
"""

# warning ì œê±°
import warnings
warnings.filterwarnings('ignore')

# êµ¬ê¸€ë“œë¼ì´ë¸Œ ì—°ê²°
from google.colab import drive
drive.mount('/content/drive')

import os
os.chdir('/content/drive/MyDrive/á„‘á…¡á„‹á…µá„Šá…¥á†« á„ƒá…¦á„‹á…µá„á…¥á„‡á…®á†«á„‰á…¥á†¨/á„€á…¢á„‹á…µá†« á„‘á…³á„…á…©á„Œá…¦á†¨á„á…³/á„á…¡á„ƒá…³ á„€á…¥á„…á…¢ á„‹á…µá„…á…§á†¨ á„‡á…®á†«á„‰á…¥á†¨á„‹á…³á†¯ á„á…©á†¼á„’á…¡á†« á„€á…©á„€á…¢á†¨á„á…³á†¨á„‰á…¥á†¼ á„‘á…¡á„‹á…¡á†¨')
os.getcwd()

# data read
import pandas as pd
df = pd.read_csv('CARD_DATA.csv')
df.head()

"""## **ğŸ”ˆProcess01**  
**â”— ì—…ì¢…ë³„ ì‚¬ìš© í˜•íƒœ ë¶„ì„**  
---

### Â· Data ì „ì²˜ë¦¬  
---
* ìˆ˜ì§‘ëœ ë°ì´í„°ì˜ ê¸°ë³¸ ì •ë³´ë“¤ì„ í™•ì¸  

  (1) Data shape(í˜•íƒœ) í™•ì¸

  (2) Data type í™•ì¸

  (3) Nullê°’ í™•ì¸ (â€» ë¹ˆ ê°’ì˜ Data)

  (4) Outlier í™•ì¸ (â€» ì •ìƒì ì¸ ë²”ì£¼ë¥¼ ë²—ì–´ë‚œ Data)
"""

# data shape
print('df', df.shape)

# data type
df.info()
# dateê°€ Objectë¡œ ê¸°ë¡ë˜ì–´ìˆìŒ
# timeë„ object

# Nullê°’ í™•ì¸
print(df.isnull().sum())
#installmentsëŠ” í• ë¶€ ì•ˆí•  ìˆ˜ë„ ìˆìœ¼ë‹ˆ nullê°’ì´ ìˆì„ ìˆ˜ ìˆì§€ë§Œ , ë‚˜ì¤‘ì— 0ìœ¼ë¡œ ë°”ê¿”ì¤˜ì•¼ì§€

# outlier
df.describe()

#í• ë¶€ê°œì›” ì¼ì‹œë¶ˆ-> 0ìœ¼ë¡œ ì²˜ë¦¬
df['installments'].fillna(0,inplace=True)

print(df.isnull().sum())

"""### Â· ì—…ì¢…ë³„ ì´ìš© ë° ë§¤ì¶œ ë¹„ì¤‘ ë¶„ì„
---  
"""

# ìƒì  ìˆ˜
df['store_id'].value_counts()

# ì—…ì¢…ë³„ ì´ìš© íšŸìˆ˜ ë¹„ì¤‘
df_store = pd.DataFrame(df['store_id'].value_counts()).reset_index()
df_store.columns = ['store_id','cnt']
df_store

# ì—…ì¢…ë³„ ì´ìš© íšŸìˆ˜ ë¹„ì¤‘ top10
df_store['total'] = df_store['cnt'].sum()
df_store['ratio'] = round((df_store['cnt']/df_store['total'])*100, 2)
df_store.sort_values(by = 'ratio', ascending= False)

# ì—…ì¢…ë³„ ë§¤ì¶œì•¡ ë¹„ì¤‘
df_amt = pd.DataFrame(df['amount'].groupby(df['store_id']).sum()).reset_index()
df_amt.sort_values(by ='amount', ascending = False)

# â–¶ ì—…ì¢…ë³„ ë§¤ì¶œì•¡ ë¹„ì¤‘ Top 10
df_amt['total'] = df_amt['amount'].sum()
df_amt['ratio'] = round( (df_amt['amount'] / df_amt['total']) * 100,2)
df_amt.head(10)

"""## **ğŸ”‰Process02**  
**â”— í•µì‹¬ ì—…ì¢… íƒìƒ‰**  
---

### Â· ì—…ì¢…ë³„ ì´ìš© ê³ ê°ìˆ˜ ë¶„ì„
---
"""

# â–¶ ìƒìœ„ì—ì„œ ì •ì˜í•œ ì´ìš© ë¹„ì¤‘ Data
df_store.columns = ['store_id', 'cnt', 'cnt_total', 'cnt_ratio']
df_store.head(5)

# â–¶ ìƒìœ„ì—ì„œ ì •ì˜í•œ ì´ìš© ë¹„ì¤‘ Data
df_amt.columns = ['store_id', 'amt', 'amt_total', 'amt_ratio']
df_amt.head(5)

# data merge
df_merge = pd.merge(df_store, df_amt, how='left', on='store_id')
df_merge.head()

# ì´ìš© ê³ ê°ìˆ˜ (unique)
df_customer = pd.DataFrame(df['card_id'].groupby(df['store_id']).nunique()).reset_index()
df_customer.columns = ['store_id','customer']
df_customer['customer_total'] = df['card_id'].nunique()
df_customer['customer_ratio'] = round((df_customer['customer']/df_customer['customer_total'])*100,2)
df_customer.sort_values(by=['customer_ratio'], ascending = False).head(10)

# ì´ìš© ê³ ê°ìˆ˜ left join
df_merge = pd.merge(df_merge, df_customer, how = 'left', on = 'store_id' )
df_merge.head(5)

"""### Â· 1íšŒ ì‚¬ìš© ê¸ˆì•¡ / ê°ë‹¨ê°€ ë¶„ì„
---
"""

# 1íšŒ ì‚¬ìš© ê¸ˆì•¡
df_merge['amt_per_use'] = round((df_merge['amt']/df_merge['cnt'])*100,2)

# ê°ë‹¨ê°€
df_merge['cus_per_use'] = round((df_merge['amt']/df_merge['customer'])*100,2)

df_merge.head(5)

"""### Â· í•µì‹¬ì—…ì¢… ì •ì˜
---
"""

# â–¶ ì´ìš© ë¹„ì¤‘, ì´ìš© ê¸ˆì•¡ ë¹„ì¤‘, ì´ìš© ê³ ê°ìˆ˜ ë¹„ì¤‘ì— ê°€ì¤‘ì¹˜ë¥¼ ì ìš©í•˜ì—¬ ìƒˆë¡œìš´ Scoreë¥¼ ì •ì˜
# â–¶ cnt_ratio(a)
# â–¶ amt_ratio(b)
# â–¶ customer_ratio(c)

a = 2
b = 4
c = 4

df_merge['core_store'] = df_merge['cnt_ratio']*a + df_merge['amt_ratio']*b + df_merge['customer_ratio']*c
df_merge.sort_values(by = 'core_store', ascending = False)

# min-maxí‘œì¤€í™”ë¥¼ í†µí•´ 100ì  ë§Œì ì˜ ì ìˆ˜ë¡œ ë³€í™˜
# Scaled Value = (Original Value âˆ’ Min Value) / (Max Value âˆ’ Min Value)

df_merge['core_store_scaled'] = df_merge['core_store'].apply(lambda x:(x - df_merge['core_store'].min()) / df_merge['core_store'].max() - df_merge['core_store'].min())
df_merge['core_store_scaled'] = round(df_merge['core_store_scaled'] * 100,0)
df_merge.sort_values(by = 'core_store_scaled', ascending = False)

"""store 753, 1342, 0, 221, 428 / ì´ 5ê°œì˜ storeë¥¼ í•µì‹¬ì—…ì¢…ìœ¼ë¡œ ì •ì˜

## **ğŸ”ŠProcess03**  
**â”— í•µì‹¬ì—…ì¢… ì¶”ê°€ ë¶„ì„**  
---

### Â· í•µì‹¬ì—…ì¢… ë°ì´í„° ì¶”ì¶œ
---
"""

# store 753, 1342, 0, 221, 428 / ì´ 5ê°œì˜ storeë¥¼ í•µì‹¬ì—…ì¢…ìœ¼ë¡œ ì •ì˜
df.head()

df_core_store = df[df['store_id'].isin([753, 1342, 0, 221, 428])]
df_core_store.head()

"""### Â· í•µì‹¬ì—…ì¢… ë…„ë„ë³„ ë§¤ì¶œ ë¹„ì¤‘ ë³€í™” ë¶„ì„
---
"""

# time data ì²˜ë¦¬
import datetime
df_core_store['Date_merge'] = df['date'].astype(str) + ' ' + df['time'].astype(str)
df_core_store['Date_merge'] = pd.to_datetime(df_core_store['Date_merge'])

df_core_store['Date_merge'].max(), df_core_store['Date_merge'].min()
#(Timestamp('2018-07-31 23:56:14'), Timestamp('2016-08-01 00:14:51'))
# â–¶ 2016ë…„ 8ì›” 1ì¼ ~ 2018ë…„ 7ì›” 31ì¼ê¹Œì§€ì˜ Data

# â–¶ ë…„, ì›”ë¡œ ì‹œê°„ë°ì´í„° ë¶„í•´
df_core_store['year'] = df_core_store['Date_merge'].dt.year
df_core_store['month'] = df_core_store['Date_merge'].dt.month
df_core_store.head()

# í•µì‹¬ ì—…ì¢… ë³„ ë§¤ì¶œê¸ˆì•¡ by ë…„ë„
df_year = pd.DataFrame(df_core_store.groupby(['store_id','year'])['amount'].sum()).reset_index()
df_year.head()

df_pivot = pd.pivot_table(df_year,              #í”¼ë²—í•  í…Œì´ë¸”
                          index = 'year',       #í–‰ ìœ„ì¹˜ì— ë“¤ì–´ê°ˆ ì—´
                          columns = 'store_id', #ì»¬ëŸ¼ ì´ë¦„
                          values = 'amount')    #ë°ì´í„°ë¡œ ì‚¬ìš©í•  ê°’
df_pivot['total'] = df_pivot.iloc[:, :5].sum(axis=1)
df_pivot = df_pivot.fillna(0)
df_pivot.head()

# â–¶ total ê¸ˆì•¡ìœ¼ë¡œ ë‚˜ëˆ ì„œ ë§¤ì¶œ ë¹„ì¤‘ìœ¼ë¡œ ë³€í™˜
df_pivot.iloc[:,0] = (df_pivot.iloc[:,0] / df_pivot['total'])
df_pivot.iloc[:,1] = (df_pivot.iloc[:,1] / df_pivot['total'])
df_pivot.iloc[:,2] = (df_pivot.iloc[:,2] / df_pivot['total'])
df_pivot.iloc[:,3] = (df_pivot.iloc[:,3] / df_pivot['total'])
df_pivot.iloc[:,4] = (df_pivot.iloc[:,4] / df_pivot['total'])

df_pivot

df_pivot = df_pivot.drop(['total'], axis=1)
df_pivot

import matplotlib.pyplot as plt
import warnings
warnings.filterwarnings('ignore')
plt.style.use(['dark_background'])

ax = df_pivot.plot(kind='barh', stacked=True, title="years amt", rot=0);
for p in ax.patches:
    left, bottom, width, height = p.get_bbox().bounds
    ax.annotate("%.1f"%(width*100), xy=(left+width/2, bottom+height/2), ha='center', va='center', color='r');

plt.box(False)
plt.gcf().set_size_inches(10, 5)
plt.show()

"""ì—…ì¢… ì„±ì¥ì„¸ì™€ í•˜ë½ì„¸
- 0, 1342 storeì€ ì•ˆì •ì  ì„±ì¥ì„¸
- 753, 221, 428 storeì€ í•˜ë½ì„¸
ìì„¸í•œ ì—…ì¢…ì„ ì•Œ ìˆ˜ ìˆì—ˆë‹¤ë©´ ì¢€ ë” ì •í™•í•œ ë¶„ì„ì´ ê°€ëŠ¥í–ˆì„í…ë° ì•„ì‰½ë‹¤ã…œ
"""

